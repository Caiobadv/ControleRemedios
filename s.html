<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Medicamentos</title>
  <meta name="description" content="Aplicativo para controle de medicamentos - acompanhe doses, estoque e hist√≥rico">
  
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üíä</text></svg>">

  <!-- Carregando React, React-DOM e Babel para funcionamento do app -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Estilos CSS -->
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #f8f8ff; /* Fundo levemente lil√°s */
      font-family: Arial, sans-serif;
    }
    
    @media (max-width: 600px) {
      /* Estilos responsivos para mobile */
      #root {
        padding: 10px;
      }
    }

    /* Paleta de cores personalizada */
    :root {
      --primary: #6a0dad; /* Roxo principal */
      --primary-light: #9370db; /* Lil√°s m√©dio */
      --primary-lighter: #e6e6fa; /* Lavanda claro */
      --white: #ffffff;
      --danger: #ff1493; /* Rosa escuro */
      --warning: #9932cc; /* Roxo m√©dio */
    }
    
    /* Estilos do modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background-color: var(--white);
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
      margin-bottom: 15px;
      font-weight: bold;
      color: var(--primary);
      border-bottom: 1px solid var(--primary-lighter);
      padding-bottom: 10px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 20px;
      gap: 10px;
    }
    
    /* Anima√ß√µes */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .fadeIn {
      animation: fadeIn 0.3s ease-in-out;
    }
  </style>
</head>
<body>
  <!-- Elemento raiz para o React renderizar o aplicativo -->
  <div id="root"></div>
  
  <!-- Script da aplica√ß√£o -->
  <script type="text/babel">
    // Aplica√ß√£o React para controle de medicamentos
    function App() {
      // Estados para armazenar os dados
      const [medications, setMedications] = React.useState([]);
      const [history, setHistory] = React.useState([]);
      const [newMedication, setNewMedication] = React.useState({
        name: '',
        dosage: '',
        frequency: '',
        stock: 0,
        alertThreshold: 5,
        lastTaken: null,
        nextDue: null,
        customSchedule: false,
        morningDose: 0,
        eveningDose: 0,
      });
      const [activeTab, setActiveTab] = React.useState('medicines');
      
      // Estado para o modal de adicionar estoque
      const [showStockModal, setShowStockModal] = React.useState(false);
      const [stockAmount, setStockAmount] = React.useState("");
      const [currentMedicationId, setCurrentMedicationId] = React.useState(null);
      
      // Estados para o modal de registro de dose
      const [showDoseModal, setShowDoseModal] = React.useState(false);
      const [selectedDoseTime, setSelectedDoseTime] = React.useState("");
      const [selectedMedicationId, setSelectedMedicationId] = React.useState(null);
      const [customDoseTime, setCustomDoseTime] = React.useState('');
      
      // Estado para o modal de confirma√ß√£o de limpar hist√≥rico
      const [showClearHistoryModal, setShowClearHistoryModal] = React.useState(false);

      // Fun√ß√£o auxiliar para formatar n√∫meros decimais (remover .0 quando for n√∫mero inteiro)
      const formatDose = (value) => {
        return value % 1 === 0 ? value.toString() : value.toFixed(1);
      };
      
      // Fun√ß√£o para agrupar o hist√≥rico por data
      const groupHistoryByDate = (historyItems) => {
        const grouped = {};
        
        historyItems.forEach(item => {
          const date = new Date(item.date);
          const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
          
          if (!grouped[dateKey]) {
            grouped[dateKey] = [];
          }
          
          grouped[dateKey].push(item);
        });
        
        // Ordenar as datas (mais recentes primeiro)
        return Object.keys(grouped)
          .sort((a, b) => {
            const [yearA, monthA, dayA] = a.split('-').map(Number);
            const [yearB, monthB, dayB] = b.split('-').map(Number);
            
            const dateA = new Date(yearA, monthA, dayA);
            const dateB = new Date(yearB, monthB, dayB);
            
            return dateB - dateA;
          })
          .reduce((result, key) => {
            result[key] = grouped[key];
            return result;
          }, {});
      };

      // Formatar a data de maneira amig√°vel
      const formatHistoryDate = (dateKey) => {
        const [year, month, day] = dateKey.split('-').map(Number);
        const date = new Date(year, month, day);
        
        // Verificar se √© hoje
        const today = new Date();
        if (
          date.getDate() === today.getDate() &&
          date.getMonth() === today.getMonth() &&
          date.getFullYear() === today.getFullYear()
        ) {
          return 'Hoje';
        }
        
        // Verificar se √© ontem
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        if (
          date.getDate() === yesterday.getDate() &&
          date.getMonth() === yesterday.getMonth() &&
          date.getFullYear() === yesterday.getFullYear()
        ) {
          return 'Ontem';
        }
        
        // Formatar como data regular
        return new Intl.DateTimeFormat('pt-BR', {
          day: '2-digit',
          month: 'long',
          year: 'numeric',
        }).format(date);
      };

      // Formatar hora
      const formatHistoryTime = (dateString) => {
        const date = new Date(dateString);
        return new Intl.DateTimeFormat('pt-BR', {
          hour: '2-digit',
          minute: '2-digit',
        }).format(date);
      };

      // Determina o tipo de atividade com base na mensagem
      const determineActivityType = (message) => {
        if (message.includes('adicionado com estoque')) {
          return 'Add';
        } else if (message.includes('foi tomado')) {
          return 'Take';
        } else if (message.includes('Adicionadas')) {
          return 'Stock';
        } else if (message.includes('removido')) {
          return 'Remove';
        } else if (message.includes('limpo')) {
          return 'Clear';
        }
        return 'Other';
      };

      // Retorna o √≠cone apropriado para cada tipo de atividade
      const getActivityIcon = (activityType) => {
        switch (activityType) {
          case 'Add': return '‚ûï';
          case 'Take': return 'üíä';
          case 'Stock': return 'üì¶';
          case 'Remove': return 'üóëÔ∏è';
          case 'Clear': return 'üßπ';
          default: return 'üìù';
        }
      };

      // Formata a mensagem de hist√≥rico para ser mais concisa e leg√≠vel
      const formatHistoryMessage = (message) => {
        // Remover "Estoque restante: X unidades" para tornar a mensagem mais curta
        let formattedMessage = message.replace(/\. Estoque restante: [\d\.]+( unidades)?\./, '.');
        
        // Substituir padr√µes comuns por vers√µes mais concisas
        formattedMessage = formattedMessage
          .replace(/Medicamento (.+) adicionado com estoque inicial de (.+) unidades\./, 'Adicionado $1 ao sistema com $2 unidades.')
          .replace(/(.+) foi tomado em (.+) \(Dose da (.+): (.+) comprimidos?\)/, '$1 - Dose da $3: $4 comprimido(s)')
          .replace(/(.+) foi tomado em (.+)\./, 'Tomou $1')
          .replace(/Adicionadas (.+) unidades de (.+) ao estoque\. Novo total: (.+) unidades\./, 'Estoque de $2 atualizado para $3 (+$1)');
          
        return formattedMessage;
      };

      // Estilos inline para os componentes
      const styles = {
        container: {
          maxWidth: '800px',
          margin: '0 auto',
          padding: '20px',
          fontFamily: 'Arial, sans-serif',
        },
        header: {
          textAlign: 'center',
          marginBottom: '30px',
          color: 'var(--primary)',
        },
        form: {
          marginBottom: '20px',
          padding: '15px',
          backgroundColor: 'var(--primary-lighter)',
          borderRadius: '8px',
          boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
        },
        input: {
          width: '100%',
          padding: '10px',
          margin: '5px 0',
          borderRadius: '4px',
          border: '1px solid #ddd',
          fontSize: '16px',
        },
        button: {
          padding: '10px 15px',
          backgroundColor: 'var(--primary)',
          color: 'var(--white)',
          border: 'none',
          borderRadius: '4px',
          cursor: 'pointer',
          margin: '5px 5px 5px 0',
          fontSize: '14px',
          transition: 'background-color 0.3s',
        },
        dangerButton: {
          backgroundColor: 'var(--danger)',
        },
        warningButton: {
          backgroundColor: 'var(--warning)',
        },
        disabledButton: {
          opacity: 0.6,
          cursor: 'not-allowed',
        },
        medicationCard: {
          border: '1px solid var(--primary-light)',
          borderRadius: '8px',
          padding: '15px',
          marginBottom: '15px',
          backgroundColor: 'var(--white)',
          boxShadow: '0 2px 4px rgba(0,0,0,0.1)',
        },
        lowStock: {
          color: 'var(--danger)',
          fontWeight: 'bold',
        },
        tabs: {
          display: 'flex',
          marginBottom: '20px',
        },
        tab: {
          padding: '12px 20px',
          backgroundColor: 'var(--primary-lighter)',
          cursor: 'pointer',
          borderRadius: '5px 5px 0 0',
          marginRight: '5px',
          transition: 'background-color 0.3s',
        },
        activeTab: {
          backgroundColor: 'var(--primary)',
          color: 'var(--white)',
        },
        medicineList: {
          marginBottom: '20px',
        },
        dosageSchedule: {
          marginTop: '10px',
          padding: '10px',
          backgroundColor: 'var(--primary-lighter)',
          borderRadius: '4px',
        },
        dosageTime: {
          display: 'inline-block',
          margin: '5px 10px 5px 0',
          padding: '5px 10px',
          backgroundColor: 'var(--primary-light)',
          color: 'white',
          borderRadius: '4px',
        },
        modalButton: {
          padding: '8px 16px',
          backgroundColor: 'var(--primary)',
          color: 'var(--white)',
          border: 'none',
          borderRadius: '4px',
          cursor: 'pointer',
        },
        modalCancelButton: {
          backgroundColor: '#aaa',
        },
        doseTimeButton: {
          padding: '10px 15px',
          margin: '5px',
          backgroundColor: 'var(--primary-lighter)',
          border: '1px solid var(--primary-light)',
          borderRadius: '4px',
          cursor: 'pointer',
          width: 'calc(50% - 10px)',
          textAlign: 'center',
        },
        selectedDoseTimeButton: {
          backgroundColor: 'var(--primary)',
          color: 'var(--white)',
        },
        // Novos estilos para o hist√≥rico redesenhado
        clearHistoryButton: {
          marginTop: '0',
          backgroundColor: 'var(--danger)',
          color: 'white',
          border: 'none',
          borderRadius: '4px',
          padding: '10px 15px',
          cursor: 'pointer',
          display: 'block',
        },
        historyHeader: {
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          marginBottom: '20px',
        },
        historyContainer: {
          maxHeight: '600px',
          overflowY: 'auto',
          borderRadius: '8px',
        },
        historyDateGroup: {
          marginBottom: '20px',
          backgroundColor: 'var(--white)',
          borderRadius: '8px',
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
          overflow: 'hidden',
        },
        historyDateHeader: {
          backgroundColor: 'var(--primary-light)',
          color: 'white',
          padding: '10px 15px',
          fontWeight: 'bold',
          borderTopLeftRadius: '8px',
          borderTopRightRadius: '8px',
        },
        historyItem: {
          padding: '12px 15px',
          borderBottom: '1px solid var(--primary-lighter)',
          display: 'flex',
          alignItems: 'flex-start',
        },
        historyTime: {
          minWidth: '70px',
          color: '#666',
          fontSize: '14px',
          paddingTop: '2px',
        },
        historyIconContainer: {
          marginRight: '15px',
          marginLeft: '5px',
        },
        historyIcon: {
          display: 'inline-flex',
          justifyContent: 'center',
          alignItems: 'center',
          width: '28px',
          height: '28px',
          borderRadius: '50%',
          fontSize: '16px',
        },
        historyIconAdd: {
          backgroundColor: '#e3f2fd',
          color: '#2196f3',
        },
        historyIconTake: {
          backgroundColor: '#e8f5e9',
          color: '#4caf50',
        },
        historyIconStock: {
          backgroundColor: '#fff3e0',
          color: '#ff9800',
        },
        historyIconRemove: {
          backgroundColor: '#ffebee',
          color: '#f44336',
        },
        historyIconClear: {
          backgroundColor: '#f3e5f5',
          color: '#9c27b0',
        },
        historyIconOther: {
          backgroundColor: '#f5f5f5',
          color: '#607d8b',
        },
        historyContent: {
          flex: 1,
          fontSize: '15px',
          lineHeight: '1.5',
        },
        // Estilos para a legenda
        legendContainer: {
          backgroundColor: 'var(--white)',
          padding: '10px 15px',
          borderRadius: '8px',
          marginBottom: '20px',
          boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
        },
        legendTitle: {
          margin: '0 0 10px 0',
          fontSize: '16px',
          color: 'var(--primary)',
        },
        legendItems: {
          display: 'flex',
          flexWrap: 'wrap',
          gap: '10px',
        },
        legendItem: {
          display: 'flex',
          alignItems: 'center',
          marginRight: '15px',
          marginBottom: '5px',
        },
        legendText: {
          marginLeft: '5px',
          fontSize: '14px',
        },
      };

      // Carregar dados do localStorage ao iniciar
      React.useEffect(() => {
        const savedMedications = localStorage.getItem('medications');
        const savedHistory = localStorage.getItem('medicationHistory');
        
        if (savedMedications) {
          setMedications(JSON.parse(savedMedications));
        }
        
        if (savedHistory) {
          setHistory(JSON.parse(savedHistory));
        }
      }, []);

      // Salvar dados no localStorage quando h√° mudan√ßas
      React.useEffect(() => {
        localStorage.setItem('medications', JSON.stringify(medications));
      }, [medications]);

      React.useEffect(() => {
        localStorage.setItem('medicationHistory', JSON.stringify(history));
      }, [history]);
      
      // Fun√ß√£o para limpar o hist√≥rico - CORRIGIDA
      const handleClearHistory = () => {
        // Limpa completamente o array de hist√≥rico, sem manter nenhum item
        setHistory([]);
        
        // Fecha o modal de confirma√ß√£o
        setShowClearHistoryModal(false);
        
        // Adiciona um novo item indicando que o hist√≥rico foi limpo
        const historyItem = {
          id: Date.now().toString(),
          date: new Date().toISOString(),
          message: 'Hist√≥rico foi limpo.',
        };
        
        // Define o hist√≥rico para conter apenas este novo item
        setHistory([historyItem]);
      };

      // Fun√ß√£o para adicionar um novo medicamento
      const handleAddMedication = (e) => {
        e.preventDefault();
        
        // Validar campos obrigat√≥rios
        if (!newMedication.name || !newMedication.dosage || newMedication.stock <= 0) {
          alert('Por favor, preencha todos os campos obrigat√≥rios.');
          return;
        }
        
        // Validar programa√ß√£o personalizada
        if (newMedication.customSchedule) {
          if (newMedication.morningDose <= 0 && newMedication.eveningDose <= 0) {
            alert('Por favor, especifique pelo menos uma dose para o per√≠odo da manh√£ ou da noite.');
            return;
          }
        } else if (!newMedication.frequency) {
          // Frequ√™ncia √© obrigat√≥ria apenas para programa√ß√£o padr√£o
          alert('Por favor, especifique a frequ√™ncia do medicamento.');
          return;
        }
        
        // Calcular pr√≥xima data
        let nextDue;
        const now = new Date();
        
        if (newMedication.customSchedule) {
          // Para programa√ß√£o personalizada, pr√≥xima dose depende do hor√°rio atual
          const hour = now.getHours();
          
          if (hour < 12 && newMedication.morningDose > 0) {
            // Se for de manh√£, pr√≥xima dose √© em 12 horas
            nextDue = calculateNextDue(now, "", "morning");
          } else if (newMedication.eveningDose > 0) {
            // Se for de tarde/noite, pr√≥xima dose √© em 12 horas
            nextDue = calculateNextDue(now, "", "evening");
          } else {
            // Caso s√≥ tenha dose da manh√£, agendar para a manh√£ do dia seguinte
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(8, 0, 0); // 8:00 AM
            nextDue = tomorrow.toISOString();
          }
        } else {
          // Para programa√ß√£o padr√£o, usar frequ√™ncia
          nextDue = calculateNextDue(now, newMedication.frequency);
        }
        
        const medicationWithId = {
          ...newMedication,
          id: Date.now().toString(),
          nextDue,
        };
        
        setMedications([...medications, medicationWithId]);
        setNewMedication({
          name: '',
          dosage: '',
          frequency: '',
          stock: 0,
          alertThreshold: 5,
          lastTaken: null,
          nextDue: null,
          customSchedule: false,
          morningDose: 0,
          eveningDose: 0,
        });
        
        // Adicionar ao hist√≥rico
        addToHistory(`Medicamento ${medicationWithId.name} adicionado com estoque inicial de ${formatDose(medicationWithId.stock)} unidades.`);
      };
      
      // Fun√ß√£o para abrir o modal de tomar medicamento
      const openTakeMedicationModal = (id) => {
        const medication = medications.find(med => med.id === id);
        setSelectedMedicationId(id);
        
        if (medication.customSchedule) {
          setShowDoseModal(true);
          setSelectedDoseTime("");
          setCustomDoseTime(''); // Resetar o campo de hor√°rio personalizado
        } else {
          // Para medicamentos com programa√ß√£o normal, registrar diretamente
          handleTakeMedication(id);
        }
      };
      
      const handleTakeMedication = (id, doseTime = null, customTime = null) => {
        // Usar o hor√°rio personalizado se fornecido, caso contr√°rio usar o hor√°rio atual
        let now;
        if (customTime && customTime !== '') {
          now = new Date(customTime);
        } else {
          now = new Date();
        }
        
        setMedications(medications.map(med => {
          if (med.id === id) {
            let doseAmount = 1; // Dose padr√£o
            let doseDescription = "";
            
            // Se for programa√ß√£o personalizada e um hor√°rio foi selecionado
            if (med.customSchedule && doseTime) {
              if (doseTime === "morning") {
                doseAmount = med.morningDose;
                doseDescription = ` (Dose da manh√£: ${formatDose(doseAmount)} comprimido${doseAmount !== 1 ? 's' : ''})`;
              } else if (doseTime === "evening") {
                doseAmount = med.eveningDose;
                doseDescription = ` (Dose da noite: ${formatDose(doseAmount)} comprimido${doseAmount !== 1 ? 's' : ''})`;
              }
            }
            
            // Calcular pr√≥xima data com base na frequ√™ncia e no hor√°rio informado (retroativo ou atual)
            const nextDue = calculateNextDue(now, med.frequency, doseTime);
            const newStock = med.stock - doseAmount;
            
            // Adicionar ao hist√≥rico usando o hor√°rio informado
            addToHistory(`${med.name} foi tomado em ${formatDate(now)}${doseDescription}. Estoque restante: ${formatDose(newStock)} unidades.`);
            
            return {
              ...med,
              lastTaken: now.toISOString(), // Usar o hor√°rio informado como √∫ltimo hor√°rio de tomada
              nextDue,
              stock: newStock,
            };
          }
          return med;
        }));
        
        setShowDoseModal(false);
        setCustomDoseTime(''); // Resetar o campo de hor√°rio personalizado
      };
      
      // Fun√ß√£o para abrir o modal de adicionar estoque
      const openAddStockModal = (id) => {
        setCurrentMedicationId(id);
        setStockAmount("");
        setShowStockModal(true);
      };
      
      // Fun√ß√£o para adicionar estoque de um medicamento
      const handleAddStock = () => {
        const amountToAdd = parseFloat(stockAmount);
        
        if (isNaN(amountToAdd) || amountToAdd <= 0) {
          alert('Por favor, informe um n√∫mero v√°lido maior que zero.');
          return;
        }
        
        setMedications(medications.map(med => {
          if (med.id === currentMedicationId) {
            const newStock = med.stock + amountToAdd;
            addToHistory(`Adicionadas ${formatDose(amountToAdd)} unidades de ${med.name} ao estoque. Novo total: ${formatDose(newStock)} unidades.`);
            
            return {
              ...med,
              stock: newStock,
            };
          }
          return med;
        }));
        
        setShowStockModal(false);
        setCurrentMedicationId(null);
      };

      // Fun√ß√£o para remover um medicamento
      const handleRemoveMedication = (id) => {
        const medicationToRemove = medications.find(med => med.id === id);
        if (!medicationToRemove) return;
        
        if (window.confirm(`Tem certeza que deseja remover ${medicationToRemove.name} da lista?`)) {
          setMedications(medications.filter(med => med.id !== id));
          addToHistory(`Medicamento ${medicationToRemove.name} foi removido da lista.`);
        }
      };

      // Fun√ß√£o para adicionar eventos ao hist√≥rico
      const addToHistory = (message) => {
        const historyItem = {
          id: Date.now().toString(),
          date: new Date().toISOString(),
          message,
        };
        
        setHistory([historyItem, ...history]);
      };

      // Fun√ß√£o para calcular a pr√≥xima data com base na frequ√™ncia
      const calculateNextDue = (date, frequency, doseTime = null) => {
        const nextDate = new Date(date);
        
        // Se for dose personalizada (manh√£/noite)
        if (doseTime) {
          // Configurar pr√≥xima dose para exatamente 12 horas depois
          nextDate.setHours(nextDate.getHours() + 12);
          return nextDate.toISOString();
        }
        
        // C√°lculo normal para frequ√™ncias padr√£o
        if (frequency.includes('hora')) {
          const hours = parseInt(frequency.match(/\d+/)[0]);
          nextDate.setHours(nextDate.getHours() + hours);
        } else if (frequency.includes('dia')) {
          const days = parseInt(frequency.match(/\d+/)[0]);
          nextDate.setDate(nextDate.getDate() + days);
        } else if (frequency.includes('semana')) {
          const weeks = parseInt(frequency.match(/\d+/)[0]);
          nextDate.setDate(nextDate.getDate() + (weeks * 7));
        } else if (frequency.includes('m√™s')) {
          const months = parseInt(frequency.match(/\d+/)[0]);
          nextDate.setMonth(nextDate.getMonth() + months);
        }
        
        return nextDate.toISOString();
      };

      // Fun√ß√£o auxiliar para formatar datas
      const formatDate = (date) => {
        if (!date) return 'Nunca';
        
        if (typeof date === 'string') {
          date = new Date(date);
        }
        
        return new Intl.DateTimeFormat('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        }).format(date);
      };

      // Verificar se um medicamento est√° com estoque baixo
      const isLowStock = (medication) => {
        return medication.stock <= medication.alertThreshold;
      };

      // Verificar se um medicamento est√° atrasado para ser tomado
      const isOverdue = (medication) => {
        if (!medication.nextDue) return false;
        
        const now = new Date();
        const nextDue = new Date(medication.nextDue);
        
        return nextDue < now;
      };

      // Ordenar medicamentos (atrasados primeiro, depois com estoque baixo)
      const sortedMedications = [...medications].sort((a, b) => {
        if (isOverdue(a) && !isOverdue(b)) return -1;
        if (!isOverdue(a) && isOverdue(b)) return 1;
        if (isLowStock(a) && !isLowStock(b)) return -1;
        if (!isLowStock(a) && isLowStock(b)) return 1;
        return 0;
      });

      return (
        <div style={styles.container}>
          <div style={styles.header}>
            <h1>Controle de Medicamentos</h1>
          </div>
          
          <div style={styles.tabs}>
            <div 
              style={{...styles.tab, ...(activeTab === 'medicines' ? styles.activeTab : {})}} 
              onClick={() => setActiveTab('medicines')}
            >
              Medicamentos
            </div>
            <div 
              style={{...styles.tab, ...(activeTab === 'add' ? styles.activeTab : {})}} 
              onClick={() => setActiveTab('add')}
            >
              Adicionar Novo
            </div>
            <div 
              style={{...styles.tab, ...(activeTab === 'history' ? styles.activeTab : {})}} 
              onClick={() => setActiveTab('history')}
            >
              Hist√≥rico
            </div>
          </div>
          
          {activeTab === 'add' && (
            <div style={styles.form}>
              <h2>Adicionar Novo Medicamento</h2>
              <form onSubmit={handleAddMedication}>
                <div>
                  <label htmlFor="name">Nome do Medicamento</label>
                  <input
                    id="name"
                    type="text"
                    style={styles.input}
                    value={newMedication.name}
                    onChange={(e) => setNewMedication({...newMedication, name: e.target.value})}
                    placeholder="Ex: Paracetamol"
                    required
                  />
                </div>
                
                <div>
                  <label htmlFor="dosage">Dosagem</label>
                  <input
                    id="dosage"
                    type="text"
                    style={styles.input}
                    value={newMedication.dosage}
                    onChange={(e) => setNewMedication({...newMedication, dosage: e.target.value})}
                    placeholder="Ex: 500mg, 1 comprimido"
                    required
                  />
                </div>
                
                <div style={{marginTop: '15px', marginBottom: '15px'}}>
                  <label style={{fontWeight: 'bold'}}>Tipo de Programa√ß√£o</label>
                  <div style={{display: 'flex', marginTop: '8px', gap: '10px'}}>
                    <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer'}}>
                      <input
                        type="radio"
                        name="scheduleType"
                        checked={!newMedication.customSchedule}
                        onChange={() => setNewMedication({...newMedication, customSchedule: false})}
                      />
                      <span style={{marginLeft: '8px'}}>Padr√£o (frequ√™ncia regular)</span>
                    </label>
                    <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer'}}>
                      <input
                        type="radio"
                        name="scheduleType"
                        checked={newMedication.customSchedule}
                        onChange={() => setNewMedication({...newMedication, customSchedule: true})}
                      />
                      <span style={{marginLeft: '8px'}}>Personalizado (manh√£/noite)</span>
                    </label>
                  </div>
                </div>
                
                {!newMedication.customSchedule ? (
                  <div>
                    <label htmlFor="frequency">Frequ√™ncia</label>
                    <input
                      id="frequency"
                      type="text"
                      style={styles.input}
                      value={newMedication.frequency}
                      onChange={(e) => setNewMedication({...newMedication, frequency: e.target.value})}
                      placeholder="Ex: 8 horas, 1 dia, 1 semana"
                      required={!newMedication.customSchedule}
                    />
                  </div>
                ) : (
                  <div style={{border: '1px solid var(--primary-light)', borderRadius: '5px', padding: '10px', marginBottom: '15px'}}>
                    <p style={{marginTop: '0', marginBottom: '10px', fontWeight: 'bold'}}>Programa√ß√£o Di√°ria (a cada 12 horas)</p>
                    
                    <div>
                      <label htmlFor="morningDose">Dose da Manh√£ (comprimidos)</label>
                      <input
                        id="morningDose"
                        type="number"
                        style={styles.input}
                        value={newMedication.morningDose}
                        onChange={(e) => setNewMedication({...newMedication, morningDose: parseFloat(e.target.value) || 0})}
                        min="0"
                        step="0.5"
                      />
                    </div>
                    
                    <div>
                      <label htmlFor="eveningDose">Dose da Noite (comprimidos)</label>
                      <input
                        id="eveningDose"
                        type="number"
                        style={styles.input}
                        value={newMedication.eveningDose}
                        onChange={(e) => setNewMedication({...newMedication, eveningDose: parseFloat(e.target.value) || 0})}
                        min="0"
                        step="0.5"
                      />
                    </div>
                  </div>
                )}
                
                <div>
                  <label htmlFor="stock">Estoque Inicial</label>
                  <input
                    id="stock"
                    type="number"
                    style={styles.input}
                    value={newMedication.stock}
                    onChange={(e) => setNewMedication({...newMedication, stock: parseFloat(e.target.value) || 0})}
                    min="0.5"
                    step="0.5"
                    required
                  />
                </div>
                
                <div>
                  <label htmlFor="alertThreshold">Alerta de Estoque Baixo</label>
                  <input
                    id="alertThreshold"
                    type="number"
                    style={styles.input}
                    value={newMedication.alertThreshold}
                    onChange={(e) => setNewMedication({...newMedication, alertThreshold: parseFloat(e.target.value) || 0})}
                    min="0.5"
                    step="0.5"
                  />
                </div>
                
                <button type="submit" style={styles.button}>Adicionar Medicamento</button>
              </form>
            </div>
          )}
          
          {activeTab === 'medicines' && (
            <div style={styles.medicineList}>
              <h2>Lista de Medicamentos</h2>
              
              {sortedMedications.length === 0 ? (
                <p>Nenhum medicamento cadastrado. Use a aba "Adicionar Novo" para cadastrar medicamentos.</p>
              ) : (
                sortedMedications.map(medication => (
                  <div key={medication.id} style={styles.medicationCard}>
                    <h3>{medication.name}</h3>
                    <p><strong>Dosagem:</strong> {medication.dosage}</p>
                    
                    {medication.customSchedule ? (
                      <div style={styles.dosageSchedule}>
                        <p><strong>Programa√ß√£o Personalizada (a cada 12 horas):</strong></p>
                        {medication.morningDose > 0 && (
                          <div style={styles.dosageTime}>
                            Manh√£: {formatDose(medication.morningDose)} comprimido{medication.morningDose !== 1 ? 's' : ''}
                          </div>
                        )}
                        {medication.eveningDose > 0 && (
                          <div style={styles.dosageTime}>
                            Noite: {formatDose(medication.eveningDose)} comprimido{medication.eveningDose !== 1 ? 's' : ''}
                          </div>
                        )}
                      </div>
                    ) : (
                      <p><strong>Frequ√™ncia:</strong> {medication.frequency}</p>
                    )}
                    
                    <p>
                      <strong>Estoque:</strong> 
                      <span style={isLowStock(medication) ? styles.lowStock : {}}>
                        {formatDose(medication.stock)} unidades
                        {isLowStock(medication) && ' (Estoque Baixo)'}
                      </span>
                    </p>
                    <p><strong>√öltima vez tomado:</strong> {formatDate(medication.lastTaken)}</p>
                    <p>
                      <strong>Pr√≥xima dose prevista:</strong> 
                      <span style={isOverdue(medication) ? styles.lowStock : {}}>
                        {formatDate(medication.nextDue)}
                        {isOverdue(medication) && ' (Atrasado)'}
                      </span>
                    </p>
                    
                    <div>
                      <button 
                        style={{
                          ...styles.button,
                          ...(medication.stock <= 0 ? styles.disabledButton : {})
                        }} 
                        onClick={() => openTakeMedicationModal(medication.id)}
                        disabled={medication.stock <= 0}
                      >
                        Registrar Dose
                      </button>
                      
                      <button 
                        style={{...styles.button, ...styles.warningButton}} 
                        onClick={() => openAddStockModal(medication.id)}
                      >
                        Adicionar Estoque
                      </button>
                      
                      <button 
                        style={{...styles.button, ...styles.dangerButton}} 
                        onClick={() => handleRemoveMedication(medication.id)}
                      >
                        Remover
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>
          )}
          
          {activeTab === 'history' && (
            <div>
              <div style={styles.historyHeader}>
                <h2>Hist√≥rico de Atividades</h2>
                {history.length > 0 && (
                  <button 
                    style={styles.clearHistoryButton}
                    onClick={() => setShowClearHistoryModal(true)}
                  >
                    Limpar Hist√≥rico
                  </button>
                )}
              </div>
              
              {/* Legenda dos √≠cones */}
              <div style={styles.legendContainer}>
                <h4 style={styles.legendTitle}>Legenda:</h4>
                <div style={styles.legendItems}>
                  <div style={styles.legendItem}>
                    <span style={{...styles.historyIcon, ...styles.historyIconAdd}}>‚ûï</span>
                    <span style={styles.legendText}>Adi√ß√£o de medicamento</span>
                  </div>
                  <div style={styles.legendItem}>
                    <span style={{...styles.historyIcon, ...styles.historyIconTake}}>üíä</span>
                    <span style={styles.legendText}>Dose tomada</span>
                  </div>
                  <div style={styles.legendItem}>
                    <span style={{...styles.historyIcon, ...styles.historyIconStock}}>üì¶</span>
                    <span style={styles.legendText}>Estoque adicionado</span>
                  </div>
                  <div style={styles.legendItem}>
                    <span style={{...styles.historyIcon, ...styles.historyIconRemove}}>üóëÔ∏è</span>
                    <span style={styles.legendText}>Medicamento removido</span>
                  </div>
                  <div style={styles.legendItem}>
                    <span style={{...styles.historyIcon, ...styles.historyIconClear}}>üßπ</span>
                    <span style={styles.legendText}>Hist√≥rico limpo</span>
                  </div>
                </div>
              </div>
              
              {history.length === 0 ? (
                <p>Nenhuma atividade registrada.</p>
              ) : (
                <div style={styles.historyContainer}>
                  {/* Agrupamento por data */}
                  {Object.entries(groupHistoryByDate(history)).map(([date, items]) => (
                    <div key={date} style={styles.historyDateGroup}>
                      <div style={styles.historyDateHeader}>
                        <span>{formatHistoryDate(date)}</span>
                      </div>
                      
                      {items.map(item => {
                        // Determina o tipo de atividade para mostrar √≠cone apropriado
                        const activityType = determineActivityType(item.message);
                        const icon = getActivityIcon(activityType);
                        
                        return (
                          <div key={item.id} style={styles.historyItem}>
                            <div style={styles.historyTime}>
                              {formatHistoryTime(item.date)}
                            </div>
                            <div style={styles.historyIconContainer}>
                              <span style={{...styles.historyIcon, ...styles[`historyIcon${activityType}`]}}>
                                {icon}
                              </span>
                            </div>
                            <div style={styles.historyContent}>
                              {formatHistoryMessage(item.message)}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
          
          {/* Modal para adicionar estoque */}
          {showStockModal && (
            <div className="modal-backdrop fadeIn">
              <div className="modal-content">
                <div className="modal-header">
                  <h3>Adicionar Estoque</h3>
                </div>
                <div>
                  <label htmlFor="stockAmount">Quantidade a adicionar:</label>
                  <input
                    id="stockAmount"
                    type="number"
                    style={styles.input}
                    value={stockAmount}
                    onChange={(e) => setStockAmount(e.target.value)}
                    placeholder="Digite a quantidade"
                    min="0.5"
                    step="0.5"
                    autoFocus
                  />
                </div>
                <div className="modal-footer">
                  <button 
                    style={{...styles.modalButton, ...styles.modalCancelButton}} 
                    onClick={() => setShowStockModal(false)}
                  >
                    Cancelar
                  </button>
                  <button 
                    style={styles.modalButton} 
                    onClick={handleAddStock}
                  >
                    Confirmar
                  </button>
                </div>
              </div>
            </div>
          )}
          
          {/* Modal para sele√ß√£o de dose (manh√£/noite) */}
          {showDoseModal && (
            <div className="modal-backdrop fadeIn">
              <div className="modal-content">
                <div className="modal-header">
                  <h3>Registrar Dose</h3>
                </div>
                <div>
                  <p>Selecione o hor√°rio da dose:</p>
                  <div style={{display: 'flex', justifyContent: 'space-between', flexWrap: 'wrap'}}>
                    <div
                      style={{
                        ...styles.doseTimeButton,
                        ...(selectedDoseTime === 'morning' ? styles.selectedDoseTimeButton : {})
                      }}
                      onClick={() => setSelectedDoseTime('morning')}
                    >
                      Dose da Manh√£
                    </div>
                    <div
                      style={{
                        ...styles.doseTimeButton,
                        ...(selectedDoseTime === 'evening' ? styles.selectedDoseTimeButton : {})
                      }}
                      onClick={() => setSelectedDoseTime('evening')}
                    >
                      Dose da Noite
                    </div>
                  </div>
                  
                  {/* Campo para hor√°rio retroativo */}
                  <div style={{marginTop: '15px'}}>
                    <label htmlFor="customDoseTime" style={{display: 'block', marginBottom: '5px'}}>
                      Hora que foi tomado: <span style={{fontSize: '13px', color: '#666'}}>(opcional)</span>
                    </label>
                    <input
                      id="customDoseTime"
                      type="datetime-local"
                      style={styles.input}
                      value={customDoseTime}
                      onChange={(e) => setCustomDoseTime(e.target.value)}
                      max={new Date().toISOString().slice(0, 16)}
                    />
                    <p style={{fontSize: '13px', color: '#666', margin: '5px 0 0 0'}}>
                      Se n√£o preenchido, ser√° considerado o hor√°rio atual.
                    </p>
                  </div>
                </div>
                <div className="modal-footer">
                  <button 
                    style={{...styles.modalButton, ...styles.modalCancelButton}} 
                    onClick={() => setShowDoseModal(false)}
                  >
                    Cancelar
                  </button>
                  <button 
                    style={{
                      ...styles.modalButton,
                      ...(selectedDoseTime === '' ? styles.disabledButton : {})
                    }} 
                    onClick={() => handleTakeMedication(selectedMedicationId, selectedDoseTime, customDoseTime)}
                    disabled={selectedDoseTime === ''}
                  >
                    Confirmar
                  </button>
                </div>
              </div>
            </div>
          )}
          
          {/* Modal para confirma√ß√£o de limpar hist√≥rico */}
          {showClearHistoryModal && (
            <div className="modal-backdrop fadeIn">
              <div className="modal-content">
                <div className="modal-header">
                  <h3>Limpar Hist√≥rico</h3>
                </div>
                <div>
                  <p>Tem certeza que deseja limpar todo o hist√≥rico de atividades?</p>
                  <p>Esta a√ß√£o n√£o pode ser desfeita.</p>
                </div>
                <div className="modal-footer">
                  <button 
                    style={{...styles.modalButton, ...styles.modalCancelButton}} 
                    onClick={() => setShowClearHistoryModal(false)}
                  >
                    Cancelar
                  </button>
                  <button 
                    style={{...styles.modalButton, ...styles.dangerButton}}
                    onClick={handleClearHistory}
                  >
                    Limpar Hist√≥rico
                  </button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Renderizar o App no elemento root
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>